<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <script type="text/javascript" src="js/libs/jquery-1.11.0.min.js"></script>
        <script src="js/libs/underscore-min.js"></script>
        <script src="js/libs/backbone-min.js"></script>
        <script src="js/libs/backbone.marionette.min.js"></script>

        <script src="../js/model/Map.js"></script>
        <script src="../js/model/MapPathFinder.js"></script>
        <script src="../js/view/MapView.js"></script>
        <script src="../js/view/MapCodeView.js"></script>
    </head>
    <body>
        <div id="content"></div>
        Stack: <span id="stack"></span>
        Mapid: <input type="text" id="mapid" value="154" />
        <button id="getMapcode">Get</button>
        <br>
        <textarea cols="100" rows="50" style="font-size: 8px" id="mapCodeView"></textarea><br>
        <button id="getMainfill">Mainfill</button>
        <button id="getNextpath">Next Path</button>
        <br>
        <svg xmlns="http://www.w3.org/2000/svg"
             xmlns:xlink="http://www.w3.org/1999/xlink" id="mapview" width="300" height="200" style="border: 1px solid red">
            <defs>
                <style type="text/css">
                    .grass {
                        fill: rgb(0, 200, 0);
                    }

                    .road {
                        fill: rgb(128, 128, 128);
                    }

                    .start {
                        fill: rgb(200,200,200)
                    }

                    .finish {
                        fill: rgb(255,255,255)
                    }

                    .mud {
                        fill: rgb(100, 70, 0);
                    }

                    .sand {
                        fill: rgb(230, 230, 115);
                    }

                    .water {
                        fill: blue;
                    }

                    .earth {
                        fill: brown;
                    }

                    .parc {
                        fill: rgb(200, 200, 200);
                    }

                    .cp1 {
                        fill: rgb(0, 102, 255);
                    }

                    .cp2 {
                        fill: rgb(0, 100, 200);
                    }

                    .cp3color {
                        fill: rgb(0, 255, 102);
                    }

                    .cp3 {
                        fill: url(#cp3)
                    }

                    .cp4 {
                        fill: rgb(0, 200, 0);
                    }

                    .cp5 {
                        fill: rgb(255, 255, 0);
                    }

                    .cp6 {
                        fill: rgb(200, 200, 0);
                    }

                    .cp7 {
                        fill: rgb(255, 0, 0);
                    }

                    .cp8 {
                        fill: rgb(200, 0, 0);
                    }

                    .cp9 {
                        fill: rgb(255, 0, 255);
                    }

                    .primaryColor {
                        fill: rgb(0,255,102)
                    }

                </style>
                <!--<filter id='n' x='0' y='0'>
                    <feTurbulence type='fractalNoise' baseFrequency='2' numOctaves='1' stitchTiles='stitch'/>
                </filter> -->
                <pattern id="grid" patternUnits="userSpaceOnUse" width="13" height="13" x="0" y="0">
                    <line x1="13" y1="0" x2="13" y2="13" stroke="black" stroke-width="1"></line>
                    <line x1="0" y1="13" x2="13" y2="13" stroke="black" stroke-width="1"></line>
                </pattern>
                <pattern id="cp3" patternUnits="userSpaceOnUse" width="13" height="13" x="0" y="0">
                    <rect x="0" y="0" width="13" height="13" class="primaryColor"></rect>
                    <path d="M0,0L3,0L3,3L0,3L0,0M6,0L9,0L9,3L6,3L6,0M3,3L6,3L6,6L3,6L3,3M9,3L12,3L12,6L9,6L9,3" fill="black"></path>
                    <path d="M0,6L3,6L3,9L0,9L0,6M6,6L9,6L9,9L6,9L6,6M3,9L6,9L6,12L3,12L3,9M9,9L12,9L12,12L9,12L9,9" fill="black"></path>
                </pattern>
            </defs>
            <rect id="mainfill" class="" x="0" y="0" width="100%" height="100%" />
            <!--<rect x="0" y="0" width="100%" height="100%" filter="url(#n)" opacity='0.7'/>-->
            <g id="paths">
            </g>
            <rect x="0" y="0" width="100%" height="100%" fill="url(#grid)" opacity=".3"></rect>
        </svg>
        <img src="http://reloaded.karopapier.de/images/maps/154_12_1_1.png">

        <script type="text/javascript">

            var MAP_FIELDS = {
                "F": "finish",
                "O": "road",
                "P": "parc",
                "S": "start",
                "V": "stone",
                "W": "water",
                "X": "grass",
                "Y": "sand",
                "Z": "mud",
                "1": "cp1",
                "2": "cp2",
                "3": "cp3",
                "4": "cp4",
                "5": "cp5",
                "6": "cp6",
                "7": "cp7",
                "8": "cp8",
                "9": "cp9"
            };
            $('#getMapcode').click(function () {
                $.getJSON("http://reloaded.karopapier.de/api/mapcode/" + $('#mapid').val() + ".json?callback=?", function (data) {
                    map.set("mapcode", data);
                })
            })

            $('#getMainfill').click(function () {

                var mostChar = mapPathFinder.getMainField();
                console.log(mostChar, MAP_FIELDS[mostChar]);
                $('#mainfill').attr("class", MAP_FIELDS[mostChar]);

                var mc = map.get("mapcode");
                mc = mc.replace(new RegExp(mostChar, "g"), "_");
                map.set("mapcode", mc);

            })

            function makeSVG(tag, attrs) {
                var el = document.createElementNS('http://www.w3.org/2000/svg', tag);
                for (var k in attrs)
                    el.setAttribute(k, attrs[k]);
                return el;
            }

            $('#getNextpath').click(function () {
                mapPathFinder.getAllOutlines();

                for (var char in mapPathFinder.outlines) {
                    console.log(char);
                    var path = mapPathFinder.getSvgPathFromOutlines(mapPathFinder.outlines[char])
                    mapPathFinder.paths.add(new Path({
                        path: path,
                        class: MAP_FIELDS[char]
                    }));
                }

                //for (var i = 0; i < mapPathFinder.paths.length; i++) {
                //var path = mapPathFinder.paths[i];
                //console.log(path);
                //}
            })

            /* init stuff */
            var map = new Map();
            map.bind("change:rows change:cols", function () {
                $('#mapview').attr({
                    width: map.get("cols") * 13,
                    height: map.get("rows") * 13
                })
            })

            var mapView = new MapView({
                model: map,
                size: 20,
                border: 2
            });

            var mapCodeView = new MapCodeView({
                model: map,
                el: "#mapCodeView"
            })

            var Path = Backbone.Model.extend({

            });

            var PathCollection = Backbone.Collection.extend({
                model: Path
            })

            var mapPathFinder = new MapPathFinder({
                map: map
            })

            var PathCollectionView = Backbone.View.extend({
                collection: PathCollection,
                initialize: function () {
                    var me = this;
                    this.collection.bind("add", function (path) {
                        console.log("Path added", path);
                        var p = makeSVG("path", {
                            d: path.get("path"),
                            class: path.get("class")
                            //stroke: "#0FF",
                            //"stroke-width": "1"
                        })
                        //var p = makeSVG("path",{d: path.get("path"), class: path.get("class")})
                        me.el.appendChild(p);
                    })
                }
            })

            var pathCollectionView = new PathCollectionView({
                el: document.getElementById('paths'),
                collection: mapPathFinder.paths
            })

            map.set("mapcode", "XXXXXXX\nXOSOFOX\nXXXXXXX");

        </script>

    </body>
</html>