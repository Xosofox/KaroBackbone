<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>KaroBackbone</title>
        <link rel="shortcut icon" href="http://reloaded.karopapier.de/favicon.ico" />
        <link rel="stylesheet" type="text/css" media="screen" href="http://reloaded.karopapier.de/css/karo.css" />
        <link rel="stylesheet" type="text/css" media="screen" href="http://reloaded.karopapier.de/themes/black/css/theme.css" />
        <style type="text/css">
            .GameAppNavigation {
                position: absolute;
                right: 0;
                bottom: 0;
            }
            .clickable:hover {
                cursor: pointer;
            }
        </style>
    </head>

    <body>
        <div id="header">
            <div id="infoBar">
            <span class="userLabel" name="userLabel1">Didi</span> Spiele: <a href="/dran"><span id="dranCount">5</span></a>/<span id="gamesCount">105</span> [5/105]
            <a href="/logout">Logout</a>                <div id="NotifierContainer"></div>
            </div>
        </div>
        <div class="clearer"></div>

        <div id="container">
            <div id="sidebar">
                <ul id="navi">
                    <li><a href="#game/70321">Spiel</a></li>
                    <li><a href="http://reloaded.karopapier.de/dran">Dran</a></li>
                    <li><a href="http://reloaded.karopapier.de/user/settings">Einstellungen</a></li>
                    <li><a href="http://reloaded.karopapier.de/blocker">Live-Block</a></li>
                    <li><a href="http://reloaded.karopapier.de/faqs">Karo2.0 FAQs</a></li>
                    <li><a href="http://reloaded.karopapier.de/lobby/createGame">Teaser</a></li>
                </ul>
            </div>
        <div id="content">
            <div class="boxtr"> <div class="boxtl"> <div class="boxbr"> <div class="boxbl"> <div class="boxcontent">
                                <h1>KaroBackbone</h1>
            </div> </div> </div> </div> </div>

            

        </div>

        <center><a href="http://www.karopapier.de">Karopapier.de</a> is brought to you by
        <script type="text/javascript">document.write(String.fromCharCode(0x44,0x69,0x64,0x69).link(String.fromCharCode(0x6d,0x61,0x69,0x6c,0x74,0x6f,0x3a,0x64,0x69,0x64,0x69,0x40,0x6b,0x61,0x72,0x6f,0x70,0x61,0x70,0x69,0x65,0x72,0x2e,0x64,0x65)));</script></center>

        <!-- <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
        <script type="text/javascript" src="http://documentcloud.github.com/backbone/backbone-min.js"></script>
        <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script> -->
        <script type="text/javascript" src="js/underscore-min.js"></script>
        <script type="text/javascript" src="js/jquery-latest.min.js"></script>
        <script type="text/javascript" src="js/backbone-min.js"></script>

        <script type="text/javascript">
            var app;
            var GameAppView;
            $(document).ready(function() {
                app=new AppView();
                app.router= new AppRouter();
                var g= new Game();
                app.gameAppView=new GameAppView({model: g});
                $("#content").append(app.gameAppView.$el);
                console.log("Here I am");

                //Backbone.history.start({pushState: true});
                Backbone.history.start();
            });

            var AppView = Backbone.View.extend({
            });

            var Game = Backbone.Model.extend({
                defaults: {
                    id: 0
                },

                url: function() {
                    return "http://reloaded.karopapier.de/api/game/"+this.get("id")+"/details.json?callback=?";
                },

                parse: function(data) {
                    //make sure data is matching current gameId (delayed reposens get dropped)
                    if (data.game.id==this.id) {
                        this.map.set(data.map);
                        this.players.reset(data.players);
                        return data.game;
                    } else {
                        //drop it
                    }
                },

                initialize: function() {
                    this.map = new Map();
                    this.players = new PlayerCollection();
                    this.bind("change:id", function (o,id,c,d) {
                        //neu holen
                        console.log(id);
                        this.fetch();
                    });
                }
            });

            var Map = Backbone.Model.extend({
                defaults: {
                    id: 0
                },

                initialize: function() {
                    this.bind("change:id",function(o,id) {
                        console.log(" New Map id: "+id);
                    });
                }
            });

            var MapView=Backbone.View.extend({
                className: "mapView",
                initialize: function() {
                    _.bindAll(this);
                    this.model.bind("change:id",this.getImage);
                },
                getImage: function() {
                    this.$el.html('<img src="http://reloaded.karopapier.de/map/'+this.model.get("id")+'.png?size=12&border=1&cps=0" />');
                }


            });

            var Player = Backbone.Model.extend({
                defaults: {
                    id: 0
                },

                initialize: function() {
                    this.moves=new MoveCollection();
                    this.lastmove=new Move();
                    this.bind("change:id",function(o,id) {
                        console.log(" New Player id: "+id);
                    });
                }
            });

            var PlayerCollection = Backbone.Collection.extend({
                model: Player,

                initialize: function() {
                    this.bind("reset",function(o,id) {
                        console.log(o);
                    });
                }
            });

            var PlayerCollectionView = Backbone.View.extend({
                className: "playerCollection"
            });

            var Move = Backbone.Model.extend({
                defaults: {
                    x: 0,
                    y: 0,
                    xv: 0,
                    yv: 0
                }
            });

            var MoveCollection = Backbone.Collection.extend({
                model: Move
            });

            //container for rendered map and players
            var GameView = Backbone.View.extend({
                className: "gameView"
            });

            var GameAppView = Backbone.View.extend({
                tagName: "div",
                className: "GameApp",

                initialize: function() {
                    _.bindAll(this);
                    this.gameView=new GameView({model:this.model});
                    this.mapView=new MapView({model: this.model.map});
                    this.mapView.render();
                    this.render();
                    this.$el.append(this.mapView.$el);
                    this.playerCollectionView=new PlayerCollectionView({model:this.model.players});

                    //init game navigation
                    this.navigation=new GameAppNavigationView();
                    this.navigation.render();
                    this.$el.append(this.navigation.$el);
                    this.model.bind("change",this.refresh);
                },

                close: function() {
                    //remove child views
                    this.mapView.close();
                    this.playerCollectionView.close();
                    this.navigation.close();
                    alert("Remove myself");
                    this.$el.remove();
                },

                render: function() {
                    this.title=$(document.createElement('h1'));
                    this.$title=$(this.title);
                    this.$title.attr("id","gameName");
                    this.$el.append(this.title);
                },

                refresh: function() {
                    console.log("TRIGGGER");
                    console.log(this.model);
                    console.log(this.model.get("name"));
                    this.$title.text(this.model.get("name"))
                },

                setGameId: function(gameId) {
                    if (gameId!=0) {
                        this.model.set({ "id": gameId });
                    }
                }

            })

            var GameAppNavigationView = Backbone.View.extend({
                tagName: "div",
                className: "GameAppNavigation",
                events: {
                    'click .next': "nextGame"
                },

                render: function() {
                    console.log("Rendering nav");
                    this.$el.html('<span class="clickable next">Next</a>');
                },

                "nextGame": function() {
                    console.log("Next Game");
                    var oldId=parseInt(app.gameAppView.model.get("id"));
                    app.router.navigate('game/'+(oldId+1),{trigger: true});
                }
            })

            var AppRouter = Backbone.Router.extend({
                routes: {
                    "game/:gameId": "showGame",
                    "game": "showGame",
                    "": "showGame"
                },

                showGame: function(gameId) {
                    console.log("Routing to "+gameId);
                    gameId = gameId || 70000;
                    app.gameAppView.setGameId(gameId);
                }
            });


        </script>


    </body>
</html>
