<!DOCTYPE html>
<html>
    <head>
        <title>Karopapier 2.1</title>
        <script type="text/javascript" src="js/libs/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="js/libs/jquery-ui-1.10.4.custom.min.js"></script>
        <script type="text/javascript" src="js/libs/underscore-min.js"></script>
        <script type="text/javascript" src="js/libs/backbone-min.js"></script>
        <script type="text/javascript" src="js/libs/backbone.marionette.min.js"></script>
        <script type="text/javascript" src="js/libs/backbone-model-factory-min.js"></script>
        <script type="text/javascript" src="js/libs/hammer.min.js"></script>
        <!--<script type="text/javascript" src="js/libs/Sideslide.js"></script> -->
        <!--<script type="text/javascript" src="js/libs/touch-emulator.js"></script>
        <script> TouchEmulator(); </script> -->

        <script type="text/javascript" src="js/libs/TURTED.js"></script>
        <script type="text/javascript" src="js/libs/sockjs-0.3.min.js"></script>

        <script type="text/javascript">
            var Karopapier = new Marionette.Application(); // currently only for Util.js to not throw an error
        </script>

        <script type="text/javascript" src="js/templates/JST.js"></script>
        <script type="text/javascript" src="js/KaroBackbone.min.js"></script>

        <link id="favicon" rel="shortcut icon" href="favicon.ico" />

        <link rel="stylesheet" href="css/main.css" />
        <link rel="stylesheet" href="css/global.css?v=3" />
        <link rel="stylesheet" href="css/chat.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <meta charset="utf-8" />
    </head>
    <body>
        <header id="header"></header>
        <div id="content">Content</div>
        <footer id="footer">
            <a href="http://www.karopapier.de">Karopapier.de</a> is brought to you by
            <script type="text/javascript">document.write(String.fromCharCode(0x44, 0x69, 0x64, 0x69).link(String.fromCharCode(0x6d, 0x61, 0x69, 0x6c, 0x74, 0x6f, 0x3a, 0x64, 0x69, 0x64, 0x69, 0x40, 0x6b, 0x61, 0x72, 0x6f, 0x70, 0x61, 0x70, 0x69, 0x65, 0x72, 0x2e, 0x64, 0x65)));</script>
        </footer>

        <script type="text/javascript">

            var vent = new Backbone.Wreqr.EventAggregator();

            Karopapier.addInitializer(function (options) {
                // do useful stuff here
                console.log("Initializer der App");
                Karopapier.User = new User({});
                //make this user refer to "check" for loging in
                Karopapier.User.url = function () {
                    return "http://www.karopapier.de/api/user/check.json?callback=?"
                }
                Karopapier.User.fetch();
            });

            vent.on("logout", function() {
                console.log("Logging out");
                Karopapier.User.set("id", 0);
                console.log(Karopapier.User);
            })

            vent.on("login", function() {
                console.log("Logging in");
                $.post("http://www.karopapier.de/api/user/login.json",{"login":login, "password":pass},function(data) {
                    console.log(data);
                    Karopapier.User.set(data);
                })
                /*
                Karopapier.User.url = function () {
                    return "http://www.karopapier.de/api/user/check.json?callback=?"
                }
                Karopapier.User.fetch();
                */
            })

            $(document).ready(function () {
                console.log("Doc ready, start app");
                Karopapier.start({
                    baseApiUrl: "http://www.karopapier.de/api/"
                });

                console.log("App started");
                Karopapier.addRegions({
                    header: '#header',
                    content: '#content',
                    footer: '#footer'
                })

                Karopapier.chatApp = new ChatApp();
                Karopapier.content.show(Karopapier.chatApp);

                var favi = new FaviconView({
                    model: Karopapier.User,
                    el: '#favicon'
                })

                var infoBar = new UserInfoBar({
                    model: Karopapier.User
                });
                Karopapier.header.show(infoBar);

                var turted = new TURTED("http://ape.karopapier.de/turted");
                turted.ident(1, 'Didi', "notokenyet");
                turted.join("karochat");
                turted.join("livelog");
                turted.on('anyOtherMoved', function (data) {
                    //console.log("anyOtherMoved", data);
                    var movedUser = new User({id: data.movedId, login: data.movedLogin})
                    movedUser.decreaseDran();
                    var nextUser = new User({id: data.nextId, login: data.nextLogin});
                    nextUser.increaseDran();
                });
                turted.on('newChatMessage', function (data) {
                    Karopapier.chatApp.chatMessageCollection.fetch();
                });

				//var rightSlide = new Sideslide(document.getElementById('chatInfo'));
            })
            if ( !/karopapier/.test(window.location.hostname) ) {
                document.write('<scr' + 'ipt src="http://localhost:35729/livereload.js"></scr' + 'ipt>');
            }
        </script>
    </body>
</html>
