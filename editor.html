<!doctype html>
<html xmlns="http://www.w3.org/1999/html">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Karo Map Editor</title>
        <link rel="shortcut icon" href="http://reloaded.karopapier.de/favicon.ico" />
        <link rel="stylesheet" type="text/css" media="screen" href="http://reloaded.karopapier.de/css/karo.css" />
        <link rel="stylesheet" type="text/css" media="screen" href="http://reloaded.karopapier.de/themes/black/css/theme.css" />
        <link rel="stylesheet" type="text/css" media="screen" href="css/smoothness/jquery-ui-1.8.22.custom.css" />

        <style type="text/css">
            #editorMapArea {
                float: left;
                max-height: 600px;
                overflow: auto;
            }
            #editorTools {
                width: 300px;
                height: 500px;
                float: right;
                background-color: rgba(100,100,100,.3);
            }

            .fieldSelector {
                width: 20px;
                height: 20px;
                background-image: url('images/mapfields.png');
                float:left;
                margin: 2px;
                border: 2px solid #333;
                opacity: 0.7;
            }
            .activeFieldSelector {
                border: 2px solid white;
                opacity: 1;
            }
        </style>

    </head>

    <body>
        <div id="header">
            <div id="infoBar">
                <span class="userLabel" name="userLabel1">Didi</span> Spiele: <a href="/dran"><span id="dranCount">5</span></a>/<span id="gamesCount">105</span> [5/105]
                <a href="/logout">Logout</a>                <div id="NotifierContainer"></div>
            </div>
        </div>
        <div class="clearer"></div>

        <div id="container">
            <div id="sidebar">
                <ul id="navi">
                    <li><a href="#editor/65">Map 65</a></li>
                    <li><a href="#editor/123">Map 123</a></li>
                    <li><a href="#editor/75">Map 75</a></li>
                </ul>
            </div>
            <div id="content">
            </div>
            <div class="clearer"></div>

            <center><a href="http://www.karopapier.de">Karopapier.de</a> is brought to you by
                <script type="text/javascript">document.write(String.fromCharCode(0x44,0x69,0x64,0x69).link(String.fromCharCode(0x6d,0x61,0x69,0x6c,0x74,0x6f,0x3a,0x64,0x69,0x64,0x69,0x40,0x6b,0x61,0x72,0x6f,0x70,0x61,0x70,0x69,0x65,0x72,0x2e,0x64,0x65)));</script></a>
            </center>

            <!-- <script type="text/javascript" src="http://documentcloud.github.com/underscore/underscore-min.js"></script>
            <script type="text/javascript" src="http://documentcloud.github.com/backbone/backbone-min.js"></script>
            <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script> -->
            <script type="text/javascript" src="js/libs/underscore-min.js"></script>
            <script type="text/javascript" src="js/libs/jquery-1.7.2.min.js"></script>
            <script type="text/javascript" src="js/libs/jquery-ui-1.8.22.custom.min.js"></script>
            <script type="text/javascript" src="js/libs/backbone-min.js"></script>

            <script type="text/javascript" src="js/model/Map.js"></script>
            <script type="text/javascript" src="js/model/MapRenderView.js"></script>
            <script type="text/javascript" src="js/model/MapRenderPalette.js"></script>
            <script type="text/javascript" src="js/model/ViewSettings.js"></script>

            <script type="text/javascript" src="js/templates/jst.js"></script>

            <script type="text/javascript">
                var buttonDown=[false, false, false, false] //null, left, middle, right

                function render() {
                    for (var i=1;i<=3;i++) {
                        $('#button'+i).css({backgroundColor: buttonDown[i] ? 'red' : 'transparent'});
                    }
                }

                $(document).ready(function() {


                    var EditorView=Backbone.View.extend({
                        id: 'editor',
                        initialize: function() {
                            this.settings=new ViewSettings();
                            this.editorToolsView=new EditorToolsView({ "settings": this.settings});
                            this.editorMapView= new EditorMapView({ "settings": this.settings, "tools": this.editorToolsView});
                            var mapArea=$(document.createElement("div"));
                            //resizable container mapArea
                            mapArea.attr("id","editorMapArea");
                            mapArea.append(this.editorMapView.el);
                            this.$el.append(mapArea);
                            this.$el.append(this.editorToolsView.el);
                        }
                    });

                    var EditorToolsView=Backbone.View.extend({
                        id: "editorTools",
                        initialize: function() {
                            $this=this; //for jquery ui slider
                            _.bindAll(this);
                            this.settings=this.options.settings;
                            this.$el.html(window.JST['editor/tools']);
                            this.slider=$('#size-slider',this.$el).slider({
                                value: 8,
                                min: 1,
                                max: 20
                            });
                            this.slider.bind("slide", function(event, ui) {
                                $this.settings.set("size",ui.value);
                            });
                            this.$el.bind("contextmenu",function() { return false; });
                            this.buttonColor=[null,"O","S","X"];
                            this.highlightActiveField();
                        },
                        events: {
                            "mousedown .fieldSelector": "selectField"
                        },
                        highlightActiveField: function() {
                            $('.fieldSelector',this.$el).removeClass("activeFieldSelector");
                            $('.fieldSelector[rel="'+this.buttonColor[1]+'"]',this.$el).addClass("activeFieldSelector");
                        },

                        selectField: function(e,i) {
                            this.buttonColor[e.which]=$(e.currentTarget).attr("rel");
                            this.highlightActiveField();
                        }
                    });

                    var EditorMapView=Backbone.View.extend({
                        id: "editorMapView",
                        initialize: function() {
                            _.bindAll(this);
                            this.settings=this.options.settings;
                            this.tools=this.options.tools;
                            this.map =new Map({
                                mapcode: "X"
                            });
                            this.map.setMatrixFromCode();
                            this.mapRenderView=new MapRenderView({"settings": this.settings, model: this.map});
                            this.$el.bind("contextmenu",function() { return false; });
                            this.$el.append(this.mapRenderView.el);

                            this.$el.css({"display": "inline-block"});
                        },
                        render: function () {
                            this.mapRenderView.render();
                        },
                        events: {
                            'mousedown': 'mousedown',
                            'mouseup': 'mouseup',
                            'mouseleave': 'mouseleave',
                            "contextmenu": function() {
                                return false;
                            }
                        },

                        draw: function(e) {
                            for (var i=1;i<=3;i++) {
                                if (buttonDown[i]) {
                                    var x=e.pageX-this.$el.offset().left;
                                    var y=e.pageY-this.$el.offset().top;
                                    $('#drag'+i).text("("+x+"|"+y+")");
                                    //var field=this.mapRenderView.getFieldAtXY(x,y);
                                    this.mapRenderView.setFieldAtXY(x,y,this.tools.buttonColor[i]);
                                }
                            }
                        },

                        mousedown: function(e) {
                            buttonDown[e.which]=true;
                            e.preventDefault();
                            render();
                            this.draw(e);
                            this.$el.bind("mousemove",this.mousemove);
                            return false;
                        },

                        mouseup:function(e) {
                            buttonDown[e.which]=false;
                            render();
                            this.$el.unbind("mousemove");
                        },

                        mousemove: function(e) {
                            this.draw(e);
                        },

                        mouseleave:function(e) {
                            for (var i=1;i<=3;i++) {
                                buttonDown[e.which]=false;
                            }
                            render();
                        }
                    });

                    var settings = new ViewSettings();
                    var editor= new EditorView();
                    $('#content').append(editor.el);
                    editor.editorMapView.render();

                    $.getJSON("http://reloaded.karopapier.de/api/map/list.json?callback=?",function(data) {
                        var mapcode=data[0].mapcode;
                        editor.editorMapView.map.set("mapcode",mapcode);
                        editor.editorMapView.map.setMatrixFromCode();
                        editor.editorMapView.render();
                    });
                    //here comes the ugly part
                    $(window).resize(function() {
                        recalcWidth();
                    });
                    function recalcWidth() {
                        var ww=$(window).width();
                        var nw=$('#sidebar').width();
                        var iw=$('#editorTools').width();
                        $('#editorMapArea').width(ww-nw-iw-30);

                    }
                    recalcWidth();
                });

            </script>
        </div>
    </body>
</html>
